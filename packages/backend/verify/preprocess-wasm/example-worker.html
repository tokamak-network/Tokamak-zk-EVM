<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Preprocess WASM - Web Worker (Non-blocking)</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-left: 4px solid #2196f3;
        margin: 20px 0;
        border-radius: 4px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #4caf50;
        border-radius: 4px;
      }
      .error {
        border-left-color: #f44336;
        background: #ffebee;
      }
      .log {
        background: #263238;
        color: #aed581;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .input-section {
        margin: 20px 0;
      }
      textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
      label {
        display: block;
        margin: 10px 0 5px 0;
        font-weight: bold;
        color: #555;
      }
      .progress {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
        display: none;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ffc107;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Tokamak zkEVM - Preprocess WASM (Web Worker)</h1>
      <p>Generate preprocess data in your browser without freezing the UI!</p>

      <div class="info">
        <strong>‚ÑπÔ∏è About Web Worker:</strong> This version runs the heavy computation in a background thread, 
        keeping the UI responsive. The computation still takes time (2-10 seconds), but your browser won't freeze!
      </div>

      <div class="input-section">
        <label>Sigma Preprocess JSON (File Upload - ~492MB):</label>
        <input 
          type="file" 
          id="sigmaFileInput" 
          accept=".json"
          style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px;"
        />
        <small style="color: #666;">‚ö†Ô∏è Large file will be processed in background thread (UI won't freeze)</small>

        <label style="margin-top: 20px;">Permutation JSON:</label>
        <textarea
          id="permutationInput"
          placeholder='[{"row": 0, "col": 0, "X": 0, "Y": 0}, ...]'
        ></textarea>

        <label>Setup Params JSON:</label>
        <textarea
          id="setupParamsInput"
          placeholder='{"l": 64, "l_pub_in": 32, ...}'
        ></textarea>
      </div>

      <button id="runBtn" onclick="runPreprocess()">
        üöÄ Generate Preprocess (Web Worker)
      </button>
      <button id="loadTestDataBtn" onclick="loadSmallTestData()">
        üìÇ Load Small Test Data
      </button>

      <div id="progress" class="progress">
        <div class="spinner"></div>
        <span id="progressText">Processing...</span>
      </div>

      <div id="result"></div>
      <div id="log" class="log"></div>
    </div>

    <script>
      // Web Worker instance
      let worker = null;
      let workerReady = false;
      let startTime = 0;
      let memoryMonitorInterval = null;

      // Memory detection and logging
      function getSystemMemory() {
        // Try to get device memory (in GB)
        const deviceMemory = navigator.deviceMemory || 4;
        log(`üíª Detected system memory: ${deviceMemory}GB`);
        return deviceMemory;
      }
      
      function logMemoryUsage() {
        if (performance.memory) {
          const used = (performance.memory.usedJSHeapSize / 1024 / 1024 / 1024).toFixed(2);
          const total = (performance.memory.totalJSHeapSize / 1024 / 1024 / 1024).toFixed(2);
          const limit = (performance.memory.jsHeapSizeLimit / 1024 / 1024 / 1024).toFixed(2);
          
          log(`üíæ Memory: ${used}GB used / ${total}GB total (limit: ${limit}GB)`);
          
          const usagePercent = (performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit * 100).toFixed(1);
          if (usagePercent > 80) {
            log(`‚ö†Ô∏è Warning: ${usagePercent}% memory usage!`, true);
          }
        }
      }
      
      function startMemoryMonitor() {
        log('üìä Starting memory monitor...');
        logMemoryUsage();
        memoryMonitorInterval = setInterval(logMemoryUsage, 5000); // Every 5 seconds
      }
      
      function stopMemoryMonitor() {
        if (memoryMonitorInterval) {
          clearInterval(memoryMonitorInterval);
          memoryMonitorInterval = null;
          logMemoryUsage(); // Final reading
        }
      }

      // Initialize Web Worker
      function initWorker() {
        if (worker) return;
        
        // Log system info
        const sysMemory = getSystemMemory();
        if (sysMemory >= 16) {
          log('‚úÖ High memory system detected - optimal performance expected');
        } else if (sysMemory >= 8) {
          log('‚öñÔ∏è Standard memory system - good performance expected');
        } else {
          log('‚ö†Ô∏è Low memory system - close other tabs for best performance', true);
        }
        
        log('üîÑ Initializing Web Worker...');
        // Create worker as ES6 module
        worker = new Worker('./preprocess-worker.js', { type: 'module' });
        
        worker.onmessage = function(e) {
          const { type, message, result, error } = e.data;
          
          if (type === 'INIT_COMPLETE') {
            workerReady = true;
            log('‚úÖ Web Worker ready');
          } else if (type === 'PROGRESS') {
            log(`‚è≥ ${message}`);
            document.getElementById('progressText').textContent = message;
          } else if (type === 'COMPLETE') {
            handleComplete(result);
          } else if (type === 'ERROR') {
            handleError(error);
          }
        };
        
        worker.onerror = function(error) {
          handleError(error.message);
        };
        
        // Initialize WASM in worker
        worker.postMessage({ type: 'INIT' });
      }
      
      // Handle completion
      function handleComplete(result) {
        const duration = ((performance.now() - startTime) / 1000).toFixed(2);
        
        // Stop memory monitoring
        stopMemoryMonitor();
        
        log(`‚úÖ Preprocess generated in ${duration}s`);
        
        // Hide progress
        document.getElementById('progress').style.display = 'none';
        
        // Display results
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
          <div class="result">
            <h3>‚úÖ Preprocess Generated Successfully</h3>
            <p><strong>Time:</strong> ${duration}s</p>
            <p><strong>‚ú® UI remained responsive during computation!</strong></p>
            
            <details>
              <summary><strong>Preprocess JSON (click to expand)</strong></summary>
              <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 11px;">${JSON.stringify(JSON.parse(result.preprocessJson), null, 2)}</pre>
            </details>
            
            <details>
              <summary><strong>Formatted for Solidity (click to expand)</strong></summary>
              <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 11px;">${JSON.stringify(JSON.parse(result.formattedJson), null, 2)}</pre>
            </details>
          </div>
        `;
        
        document.getElementById('runBtn').disabled = false;
      }
      
      // Handle error
      function handleError(error) {
        // Stop memory monitoring
        stopMemoryMonitor();
        
        log(`‚ùå Error: ${error}`, true);
        
        // Hide progress
        document.getElementById('progress').style.display = 'none';
        
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
          <div class="result error">
            <h3>‚ùå Error</h3>
            <p>${error}</p>
          </div>
        `;
        
        document.getElementById('runBtn').disabled = false;
      }
      
      // Run preprocess
      async function runPreprocess() {
        if (!workerReady) {
          log('‚ùå Worker not ready yet, please wait...', true);
          return;
        }
        
        const resultDiv = document.getElementById('result');
        const runBtn = document.getElementById('runBtn');
        
        try {
          runBtn.disabled = true;
          resultDiv.innerHTML = '';
          
          // Start memory monitoring
          startMemoryMonitor();
          
          log('üîÑ Starting preprocess generation (in Web Worker)...');
          
          // Get sigma from file upload
          const sigmaFile = document.getElementById('sigmaFileInput').files[0];
          if (!sigmaFile) {
            throw new Error('Please upload sigma_preprocess.json file first!');
          }
          
          log(`üìÇ Reading sigma file: ${sigmaFile.name} (${(sigmaFile.size / 1024 / 1024).toFixed(2)} MB)...`);
          const sigmaJson = await sigmaFile.text();
          log('‚úÖ Sigma file loaded into memory');
          
          // Get other inputs
          const permutationJson = document.getElementById('permutationInput').value;
          const setupParamsJson = document.getElementById('setupParamsInput').value;
          
          if (!permutationJson || !setupParamsJson) {
            throw new Error('Please provide permutation and setupParams');
          }
          
          // Show progress
          document.getElementById('progress').style.display = 'block';
          document.getElementById('progressText').textContent = 'Sending data to worker...';
          
          // Send to worker
          startTime = performance.now();
          worker.postMessage({
            type: 'PROCESS',
            data: {
              sigmaJson,
              permutationJson,
              setupParamsJson
            }
          });
          
          log('üì§ Data sent to Web Worker');
          log('üí° UI will remain responsive while processing...');
          
        } catch (e) {
          handleError(e.message || e.toString());
        }
      }
      
      // Load small test data
      async function loadSmallTestData() {
        log('üìÇ Loading small test data...');
        
        try {
          const [permutationResp, setupParamsResp] = await Promise.all([
            fetch('./data/permutation.json'),
            fetch('./data/setupParams.json'),
          ]);
          
          if (!permutationResp.ok || !setupParamsResp.ok) {
            throw new Error('Failed to load test files');
          }
          
          const permutation = await permutationResp.text();
          const setupParams = await setupParamsResp.text();
          
          document.getElementById('permutationInput').value = permutation;
          document.getElementById('setupParamsInput').value = setupParams;
          
          log('‚úÖ Test data loaded');
          log('üìÅ Now upload sigma_preprocess.json file using file input above');
        } catch (e) {
          log('‚ùå Failed to load test data: ' + e, true);
        }
      }
      
      // Log function
      function log(message, isError = false) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const color = isError ? '#ff5252' : '#aed581';
        logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }
      
      // Initialize worker on page load
      window.onload = function() {
        initWorker();
      };
    </script>
  </body>
</html>

