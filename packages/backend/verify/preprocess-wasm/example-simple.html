<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Preprocess WASM - Simple Example</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 10px 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #4caf50;
        border-radius: 4px;
      }
      .error {
        border-left-color: #f44336;
        background: #ffebee;
      }
      .log {
        background: #263238;
        color: #aed581;
        padding: 15px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }
      .input-section {
        margin: 20px 0;
      }
      textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
      }
      label {
        display: block;
        margin: 10px 0 5px 0;
        font-weight: bold;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Tokamak zkEVM - Preprocess WASM</h1>
      <p>Generate preprocess data in your browser!</p>

      <div class="input-section">
        <label>Sigma Preprocess JSON (File Upload - Large File!):</label>
        <input 
          type="file" 
          id="sigmaFileInput" 
          accept=".json"
          style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px;"
        />
        <small style="color: #666;">‚ö†Ô∏è Expected size: ~492MB. Upload your sigma_preprocess.json file.</small>

        <label style="margin-top: 20px;">Permutation JSON:</label>
        <textarea
          id="permutationInput"
          placeholder='[{"row": 0, "col": 0, "X": 0, "Y": 0}, ...]'
        ></textarea>

        <label>Setup Params JSON:</label>
        <textarea
          id="setupParamsInput"
          placeholder='{"l": 64, "l_pub_in": 32, ...}'
        ></textarea>
      </div>

      <button id="runBtn" onclick="runPreprocess()">
        üöÄ Generate Preprocess
      </button>
      <button id="loadTestDataBtn" onclick="loadSmallTestData()">
        üìÇ Load Small Test Data (Permutation + Setup)
      </button>

      <div id="result"></div>
      <div id="log" class="log"></div>
    </div>

    <script type="module">
      import init, { PreprocessWasm } from './pkg-web/preprocess_wasm.js';

      let wasmInitialized = false;

      // Initialize WASM
      async function initWasm() {
        if (!wasmInitialized) {
          await init();
          wasmInitialized = true;
          log('‚úÖ WASM module initialized');
        }
      }

      // Initialize on page load
      initWasm().catch((e) => {
        log('‚ùå Failed to initialize WASM: ' + e, true);
      });

      // Make functions global
      window.runPreprocess = async function () {
        const resultDiv = document.getElementById('result');
        const runBtn = document.getElementById('runBtn');

        try {
          runBtn.disabled = true;
          resultDiv.innerHTML = '';
          log('üîÑ Starting preprocess generation...');

          // Get sigma from file upload
          const sigmaFile = document.getElementById('sigmaFileInput').files[0];
          if (!sigmaFile) {
            throw new Error('Please upload sigma_preprocess.json file first!');
          }

          log(`üìÇ Reading sigma file: ${sigmaFile.name} (${(sigmaFile.size / 1024 / 1024).toFixed(2)} MB)...`);
          const sigmaJson = await sigmaFile.text();
          log('‚úÖ Sigma file loaded');

          // Get other inputs from textareas
          const permutationJson =
            document.getElementById('permutationInput').value;
          const setupParamsJson =
            document.getElementById('setupParamsInput').value;

          if (!permutationJson || !setupParamsJson) {
            throw new Error(
              'Please provide permutation and setupParams (use "Load Small Test Data" button)',
            );
          }

          log('üìù Parsing inputs...');

          // Initialize WASM if not already done
          await initWasm();

          // Create preprocess
          log('‚öôÔ∏è Generating preprocess...');
          const startTime = performance.now();

          const preprocess = new PreprocessWasm(
            sigmaJson,
            permutationJson,
            setupParamsJson,
          );

          const endTime = performance.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);

          log(`‚úÖ Preprocess generated in ${duration}s`);

          // Get results
          const preprocessJson = preprocess.toJSON();
          const formattedJson = preprocess.toFormattedJSON();

          // Display results
          resultDiv.innerHTML = `
            <div class="result">
              <h3>‚úÖ Preprocess Generated Successfully</h3>
              <p><strong>Time:</strong> ${duration}s</p>
              
              <details>
                <summary><strong>Preprocess JSON (click to expand)</strong></summary>
                <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 11px;">${JSON.stringify(JSON.parse(preprocessJson), null, 2)}</pre>
              </details>
              
              <details>
                <summary><strong>Formatted for Solidity (click to expand)</strong></summary>
                <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 11px;">${JSON.stringify(JSON.parse(formattedJson), null, 2)}</pre>
              </details>
            </div>
          `;

          log('‚úÖ Results displayed');

          // Clean up
          preprocess.free();
        } catch (e) {
          const errorMsg = e.toString();
          log('‚ùå Error: ' + errorMsg, true);
          resultDiv.innerHTML = `
            <div class="result error">
              <h3>‚ùå Error</h3>
              <p>${errorMsg}</p>
            </div>
          `;
        } finally {
          runBtn.disabled = false;
        }
      };

      window.loadSmallTestData = async function () {
        log('üìÇ Loading small test data (permutation + setupParams) from ./data/...');

        try {
          // Load only small files from local data directory
          const [permutationResp, setupParamsResp] = await Promise.all([
            fetch('./data/permutation.json'),
            fetch('./data/setupParams.json'),
          ]);

          if (!permutationResp.ok || !setupParamsResp.ok) {
            throw new Error('Failed to load test files');
          }

          const permutation = await permutationResp.text();
          const setupParams = await setupParamsResp.text();

          document.getElementById('permutationInput').value = permutation;
          document.getElementById('setupParamsInput').value = setupParams;

          log('‚úÖ Small test data loaded successfully');
          log('üìÅ Now upload sigma_preprocess.json file (492MB) using the file input above');
        } catch (e) {
          log('‚ùå Failed to load test data: ' + e, true);
          log(
            'üí° Make sure you have permutation.json and setupParams.json in ./data/',
            true,
          );
        }
      };

      function log(message, isError = false) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const color = isError ? '#ff5252' : '#aed581';
        logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      // Expose log function globally
      window.log = log;
    </script>
  </body>
</html>

