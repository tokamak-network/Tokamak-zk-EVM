<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tokamak zk-SNARK Verifier - WASM</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }

        h2 {
            color: #555;
            margin-top: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .file-input {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .file-input.loaded {
            border-color: #28a745;
            background: #f0fff4;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        input[type='file'] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-info {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }

        .log {
            background: #2d2d2d;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .paths {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }

        .paths code {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-pending {
            background: #ffc107;
            color: #000;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîê Tokamak zk-SNARK Verifier (WASM)</h1>
        <p>
            <strong>Native-level verification in your browser!</strong> Upload all
            required files to run complete SNARK + Keccak256 verification.
        </p>

        <div class="section">
            <h2>üìç File Locations</h2>
            <div class="paths">
                <p><strong>File Status:</strong></p>
                <code style="background: #d4edda; color: #155724;">
            ‚úì setupParams.json - Auto-loaded from qap-compiler
          </code>
                <code style="background: #d4edda; color: #155724;">
            ‚úì instance.json - Auto-loaded from synthesizer outputs
          </code>
                <code style="background: #fff3cd; color: #856404;">
            ‚ö†Ô∏è proof.json - Upload required (packages/backend/prove/output/)
          </code>
                <code style="background: #d4edda; color: #155724;">
            ‚úì preprocess.json - Auto-loaded from verify/preprocess
          </code>
                <code style="background: #d4edda; color: #155724;">
            ‚úì sigma_verify.json - Auto-loaded from trusted-setup
          </code>
            </div>
        </div>

        <div class="section">
            <h2>üì§ Upload Proof File</h2>
            <p style="color: #666; margin-bottom: 20px;">
                ‚ÑπÔ∏è Other required files are auto-loaded. You only need to upload <strong>proof.json</strong>.
            </p>

            <div class="file-grid">
                <div class="file-input" id="file-proof" style="grid-column: 1 / -1; max-width: 600px; margin: 0 auto;">
                    <label for="proof" style="font-size: 18px; color: #667eea;">
                        üìÑ Proof.json (Upload Required)
                        <span class="badge badge-pending" id="badge-proof">PENDING</span>
                    </label>
                    <input type="file" id="proof" accept=".json" style="font-size: 16px; padding: 12px;" />
                    <div class="file-info" id="info-proof" style="font-size: 14px;">No file selected</div>
                </div>
            </div>

            <details style="margin-top: 30px;">
                <summary
                    style="cursor: pointer; font-weight: bold; color: #667eea; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    üîß Advanced: Manual File Upload (Optional)
                </summary>
                <div class="file-grid" style="margin-top: 15px;">
                    <div class="file-input" id="file-setup">
                        <label for="setupParams">
                            1. Setup Parameters (Auto-loaded)
                            <span class="badge badge-pending" id="badge-setup">PENDING</span>
                        </label>
                        <input type="file" id="setupParams" accept=".json" />
                        <div class="file-info" id="info-setup">Auto-loading...</div>
                    </div>

                    <div class="file-input" id="file-instance">
                        <label for="instance">
                            2. Instance Data (Auto-loaded)
                            <span class="badge badge-pending" id="badge-instance">PENDING</span>
                        </label>
                        <input type="file" id="instance" accept=".json" />
                        <div class="file-info" id="info-instance">Auto-loading...</div>
                    </div>

                    <div class="file-input" id="file-preprocess">
                        <label for="preprocess">
                            3. Preprocess (Auto-loaded)
                            <span class="badge badge-pending" id="badge-preprocess">PENDING</span>
                        </label>
                        <input type="file" id="preprocess" accept=".json" />
                        <div class="file-info" id="info-preprocess">Auto-loading...</div>
                    </div>

                    <div class="file-input" id="file-sigma">
                        <label for="sigma">
                            4. Sigma/Trusted Setup (Auto-loaded)
                            <span class="badge badge-pending" id="badge-sigma">PENDING</span>
                        </label>
                        <input type="file" id="sigma" accept=".json" />
                        <div class="file-info" id="info-sigma">Auto-loading...</div>
                    </div>
                </div>
            </details>

            <div style="text-align: center; margin-top: 20px">
                <button id="verifyBtn" onclick="runCompleteVerification()" disabled>
                    üöÄ Run Complete Verification
                </button>
                <button onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <div class="section">
            <h2>üìä Results</h2>
            <div id="results"></div>
            <div id="progress-container" style="display: none">
                <div class="progress">
                    <div class="progress-bar" id="progress-bar">0%</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìù Verification Log</h2>
            <div id="log" class="log">Waiting for files...</div>
        </div>
    </div>

    <script type="module">
        import init, { Verifier, recoverPreprocess } from './pkg-web/verify_wasm.js';

        let wasmInitialized = false;
        let fileData = {
            setupParams: null,
            instance: null,
            proof: null,
            preprocess: null,
            sigma: null,
        };

        // Initialize WASM
        async function initWasm() {
            if (wasmInitialized) return;
            addLog('üîß Initializing WASM module...');
            try {
                await init();
                wasmInitialized = true;
                addLog('‚úÖ WASM module initialized successfully');
            } catch (err) {
                addLog(`‚ùå WASM initialization failed: ${err.message}`, 'error');
                throw err;
            }
        }

        // Auto-load default files
        async function autoLoadDefaultFiles() {
            addLog('üì¶ Auto-loading default files...');

            const files = [
                {
                    name: 'setupParams',
                    path: 'data/setupParams.json',
                    key: 'setupParams'
                },
                {
                    name: 'instance',
                    path: 'data/instance.json',
                    key: 'instance'
                },
                {
                    name: 'preprocess',
                    path: 'data/preprocess.json',
                    key: 'preprocess'
                },
                {
                    name: 'sigma',
                    path: 'data/sigma_verify.json',
                    key: 'sigma'
                }
            ];

            for (const file of files) {
                try {
                    addLog(`üìÇ Loading ${file.name}.json...`);
                    const response = await fetch(file.path);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    let json = await response.json();

                    // Special handling for preprocess - convert FormattedPreprocess to Preprocess
                    if (file.key === 'preprocess' && json.preprocess_entries_part1) {
                        addLog(`üîÑ Converting preprocess format...`, 'info');
                        try {
                            json = await recoverPreprocess(json);
                            addLog(`‚úÖ Preprocess format converted`, 'success');
                        } catch (err) {
                            addLog(`‚ùå Failed to convert preprocess: ${err}`, 'error');
                            throw err;
                        }
                    }

                    fileData[file.key] = json;

                    // Update UI
                    let info = `${response.headers.get('content-length') || '?'} bytes`;
                    if (file.key === 'setupParams') {
                        info = `n=${json.n}, s_max=${json.s_max}`;
                    } else if (file.key === 'instance') {
                        info = `${json.a_pub.length} public inputs`;
                    }
                    updateFileStatus(file.key, true, info);
                    addLog(`‚úÖ ${file.name}.json loaded`, 'success');
                } catch (err) {
                    addLog(`‚ö†Ô∏è Failed to auto-load ${file.name}: ${err.message}`, 'warning');
                    addLog(`   You can manually upload this file`, 'info');
                }
            }

            addLog('‚úÖ Auto-load complete');
            checkAllFilesLoaded(); // Update button status after auto-load
        }

        // Initialize
        initWasm().then(() => {
            checkAllFilesLoaded(); // Initial check
            autoLoadDefaultFiles();
        });

        // File reading helper
        async function readFileAsJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        resolve(json);
                    } catch (err) {
                        reject(new Error(`Invalid JSON: ${err.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const icon =
                type === 'error'
                    ? '‚ùå'
                    : type === 'success'
                        ? '‚úÖ'
                        : type === 'warning'
                            ? '‚ö†Ô∏è'
                            : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Update file status
        function updateFileStatus(name, loaded, info = '') {
            const container = document.getElementById(`file-${name}`);
            const badge = document.getElementById(`badge-${name}`);
            const infoDiv = document.getElementById(`info-${name}`);

            if (loaded) {
                container.classList.add('loaded');
                badge.textContent = 'LOADED';
                badge.className = 'badge badge-success';
                infoDiv.textContent = info;
            } else {
                container.classList.remove('loaded');
                badge.textContent = 'PENDING';
                badge.className = 'badge badge-pending';
                infoDiv.textContent = 'No file selected';
            }

            checkAllFilesLoaded();
        }

        // Check if all files are loaded
        function checkAllFilesLoaded() {
            // Only require proof.json to be manually uploaded
            // Other files are auto-loaded or can fail gracefully
            const proofLoaded = fileData.proof !== null;
            const otherFilesLoaded = fileData.setupParams !== null &&
                fileData.instance !== null &&
                fileData.preprocess !== null &&
                fileData.sigma !== null;

            // Debug logging
            console.log('File Status:', {
                setupParams: fileData.setupParams !== null,
                instance: fileData.instance !== null,
                proof: fileData.proof !== null,
                preprocess: fileData.preprocess !== null,
                sigma: fileData.sigma !== null,
                otherFilesLoaded,
                proofLoaded
            });

            // Enable button if proof is loaded AND other files are loaded
            const btn = document.getElementById('verifyBtn');
            if (!btn) {
                console.error('verifyBtn not found!');
                return;
            }

            btn.disabled = !(proofLoaded && otherFilesLoaded);

            // Update button text to show status
            if (!otherFilesLoaded) {
                btn.textContent = '‚è≥ Loading required files...';
            } else if (!proofLoaded) {
                btn.textContent = 'üì§ Upload proof.json to verify';
            } else {
                btn.textContent = 'üöÄ Run Complete Verification';
            }
        }

        // File upload handlers
        document.getElementById('setupParams').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                addLog(`üìÇ Loading ${file.name}...`);
                fileData.setupParams = await readFileAsJson(file);
                updateFileStatus(
                    'setup',
                    true,
                    `${file.size} bytes, n=${fileData.setupParams.n}`,
                );
                addLog(`‚úÖ setupParams.json loaded`, 'success');
            } catch (err) {
                addLog(`‚ùå Error loading setupParams: ${err.message}`, 'error');
            }
        });

        document.getElementById('instance').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                addLog(`üìÇ Loading ${file.name}...`);
                fileData.instance = await readFileAsJson(file);
                updateFileStatus(
                    'instance',
                    true,
                    `${file.size} bytes, ${fileData.instance.a_pub.length} public inputs`,
                );
                addLog(`‚úÖ instance.json loaded`, 'success');
            } catch (err) {
                addLog(`‚ùå Error loading instance: ${err.message}`, 'error');
            }
        });

        document.getElementById('proof').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                addLog(`üìÇ Loading ${file.name}...`);
                fileData.proof = await readFileAsJson(file);
                updateFileStatus('proof', true, `${file.size} bytes`);
                addLog(`‚úÖ proof.json loaded`, 'success');
            } catch (err) {
                addLog(`‚ùå Error loading proof: ${err.message}`, 'error');
            }
        });

        document.getElementById('preprocess').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                addLog(`üìÇ Loading ${file.name}...`);
                let json = await readFileAsJson(file);

                // Convert FormattedPreprocess to Preprocess if needed
                if (json.preprocess_entries_part1) {
                    addLog(`üîÑ Converting preprocess format...`, 'info');
                    json = await recoverPreprocess(json);
                    addLog(`‚úÖ Preprocess format converted`, 'success');
                }

                fileData.preprocess = json;
                updateFileStatus('preprocess', true, `${file.size} bytes`);
                addLog(`‚úÖ preprocess.json loaded`, 'success');
            } catch (err) {
                addLog(`‚ùå Error loading preprocess: ${err.message}`, 'error');
            }
        });

        document.getElementById('sigma').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                addLog(`üìÇ Loading ${file.name}...`);
                fileData.sigma = await readFileAsJson(file);
                updateFileStatus('sigma', true, `${file.size} bytes`);
                addLog(`‚úÖ sigma_verify.json loaded`, 'success');
            } catch (err) {
                addLog(`‚ùå Error loading sigma: ${err.message}`, 'error');
            }
        });

        // Main verification function
        window.runCompleteVerification = async function () {
            const resultsDiv = document.getElementById('results');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');

            resultsDiv.innerHTML = '';
            progressContainer.style.display = 'block';

            const updateProgress = (percent, text) => {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = text;
            };

            try {
                addLog('‚ïê'.repeat(70));
                addLog('üöÄ STARTING COMPLETE VERIFICATION');
                addLog('‚ïê'.repeat(70));

                const overallStart = performance.now();

                // Ensure WASM is initialized
                updateProgress(10, 'Initializing WASM...');
                await initWasm();

                // Create verifier
                updateProgress(20, 'Creating verifier...');
                addLog('üîß Creating verifier instance...');
                const verifier = new Verifier(
                    JSON.stringify(fileData.setupParams),
                    JSON.stringify(fileData.instance),
                    JSON.stringify(fileData.proof),
                    JSON.stringify(fileData.preprocess),
                    JSON.stringify(fileData.sigma),
                );
                addLog('‚úÖ Verifier created successfully', 'success');

                // Step 1: Keccak256 verification
                updateProgress(40, 'Verifying Keccak256...');
                addLog('üîç Running Keccak256 verification...');
                const keccakStart = performance.now();
                const keccakResult = verifier.verify_keccak256();
                const keccakTime = ((performance.now() - keccakStart) / 1000).toFixed(3);

                let keccakStatus = '';
                if (keccakResult === 0) {
                    keccakStatus = '‚úÖ PASSED';
                    addLog(`‚úÖ Keccak256 verification PASSED (${keccakTime}s)`, 'success');
                } else if (keccakResult === 1) {
                    keccakStatus = '‚ùå FAILED';
                    addLog(`‚ùå Keccak256 verification FAILED`, 'error');
                    throw new Error('Keccak256 verification failed');
                } else {
                    keccakStatus = '‚ö†Ô∏è No Data';
                    addLog(`‚ö†Ô∏è No Keccak256 data found`, 'warning');
                }

                // Step 2: SNARK verification
                updateProgress(60, 'Verifying SNARK proof...');
                addLog('üîê Running SNARK verification (this may take a moment)...');
                const snarkStart = performance.now();
                const snarkResult = verifier.verify_snark();
                const snarkTime = ((performance.now() - snarkStart) / 1000).toFixed(3);

                let snarkStatus = '';
                if (snarkResult) {
                    snarkStatus = '‚úÖ PASSED';
                    addLog(`‚úÖ SNARK verification PASSED (${snarkTime}s)`, 'success');
                } else {
                    snarkStatus = '‚ùå FAILED';
                    addLog(`‚ùå SNARK verification FAILED`, 'error');
                }

                // Final results
                updateProgress(100, 'Complete!');
                const totalTime = ((performance.now() - overallStart) / 1000).toFixed(3);

                const overallSuccess = keccakResult !== 1 && snarkResult;

                resultsDiv.innerHTML = `
            <div class="status ${overallSuccess ? 'success' : 'error'}">
              <h3>${overallSuccess ? '‚úÖ VERIFICATION PASSED!' : '‚ùå VERIFICATION FAILED'}</h3>
            </div>
            <div class="status info">
              <strong>üìä Verification Results:</strong><br><br>
              <strong>Keccak256:</strong> ${keccakStatus} (${keccakTime}s)<br>
              <strong>SNARK Proof:</strong> ${snarkStatus} (${snarkTime}s)<br>
              <strong>Total Time:</strong> ${totalTime}s
            </div>
            <div class="status info">
              <strong>üìà Setup Parameters:</strong><br>
              - Constraints (n): ${fileData.setupParams.n}<br>
              - Max placements (s_max): ${fileData.setupParams.s_max}<br>
              - Public I/O: ${fileData.setupParams.l_pub_in + fileData.setupParams.l_pub_out}<br>
              - Private I/O: ${fileData.setupParams.l_prv_in + fileData.setupParams.l_prv_out}
            </div>
          `;

                addLog('‚ïê'.repeat(70));
                addLog(`üéâ VERIFICATION COMPLETE (${totalTime}s)`);
                addLog('‚ïê'.repeat(70));

                // Clean up
                verifier.free();
                addLog('üßπ Memory cleaned up');
            } catch (err) {
                updateProgress(0, 'Error');
                resultsDiv.innerHTML = `
            <div class="status error">
              <strong>‚ùå Error:</strong><br>
              ${err.message || err}
            </div>
          `;
                addLog(`‚ùå Error: ${err.message || err}`, 'error');
                console.error('Verification error:', err);
            }
        };

        // Clear all
        window.clearAll = function () {
            fileData = {
                setupParams: null,
                instance: null,
                proof: null,
                preprocess: null,
                sigma: null,
            };

            ['setup', 'instance', 'proof', 'preprocess', 'sigma'].forEach((name) => {
                updateFileStatus(name, false);
                document.getElementById(
                    name === 'setup' ? 'setupParams' : name,
                ).value = '';
            });

            document.getElementById('results').innerHTML = '';
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('log').textContent = 'Ready to verify...\n';
            addLog('üóëÔ∏è All data cleared');
        };
    </script>
</body>

</html>