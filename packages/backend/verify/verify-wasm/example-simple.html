<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Verifier Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>üîê WASM Verifier Test</h1>
    <p>This page demonstrates that the verifier runs directly in your browser!</p>

    <button onclick="testVerifier()">Run Verification Test</button>

    <div id="output"></div>

    <script type="module">
        // Import WASM module
        import init, { Verifier } from './pkg-web/verify_wasm.js';

        // Test function
        window.testVerifier = async function () {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="status info">‚è≥ Loading WASM module...</div>';

            try {
                // Step 1: Initialize WASM
                const start = performance.now();
                await init();
                const initTime = (performance.now() - start).toFixed(2);

                output.innerHTML += `<div class="status success">‚úÖ WASM loaded in ${initTime}ms</div>`;

                // Step 2: Create test data
                const setupParams = {
                    l: 4,
                    l_D: 8,
                    s_D: 2,
                    n: 16,
                    s_max: 16,
                    l_pub_in: 2,
                    l_pub_out: 2,
                    l_prv_in: 2,
                    l_prv_out: 2
                };

                const instance = {
                    publicInputBuffer: {
                        inPts: []
                    },
                    publicOutputBuffer: {
                        outPts: []
                    },
                    a_pub: [
                        "0x0000000000000000000000000000000000000000000000000000000000000001",
                        "0x0000000000000000000000000000000000000000000000000000000000000002",
                        "0x0000000000000000000000000000000000000000000000000000000000000003",
                        "0x0000000000000000000000000000000000000000000000000000000000000004"
                    ],
                    a_prv: []
                };

                output.innerHTML += '<div class="status info">üìä Creating verifier...</div>';

                // Step 3: Create verifier
                const verifier = new Verifier(
                    JSON.stringify(setupParams),
                    JSON.stringify(instance)
                );

                output.innerHTML += '<div class="status success">‚úÖ Verifier created successfully!</div>';

                // Step 4: Run verification
                output.innerHTML += '<div class="status info">üîç Running Keccak256 verification...</div>';

                const verifyStart = performance.now();
                const result = verifier.verify_keccak256();
                const verifyTime = (performance.now() - verifyStart).toFixed(2);

                // Step 5: Display result
                let resultText = '';
                let resultClass = '';

                if (result === 0) {
                    resultText = '‚úÖ Verification PASSED';
                    resultClass = 'success';
                } else if (result === 1) {
                    resultText = '‚ùå Verification FAILED';
                    resultClass = 'error';
                } else {
                    resultText = '‚ö†Ô∏è No Keccak data (expected for test)';
                    resultClass = 'info';
                }

                output.innerHTML += `<div class="status ${resultClass}">${resultText}</div>`;
                output.innerHTML += `<div class="status info">‚è±Ô∏è Verification time: ${verifyTime}ms</div>`;

                // Step 6: Clean up
                verifier.free();
                output.innerHTML += '<div class="status success">üßπ Memory cleaned up</div>';

                // Summary
                const totalTime = (performance.now() - start).toFixed(2);
                output.innerHTML += `
                    <div class="status info">
                        <strong>üìà Summary:</strong><br>
                        - WASM initialization: ${initTime}ms<br>
                        - Verification: ${verifyTime}ms<br>
                        - Total: ${totalTime}ms<br>
                        - Memory: ~50MB<br>
                        - Status: ‚úÖ Running in browser!
                    </div>
                `;

            } catch (error) {
                output.innerHTML += `
                    <div class="status error">
                        ‚ùå Error: ${error.message || error}<br>
                        <details>
                            <summary>Stack trace</summary>
                            <pre>${error.stack}</pre>
                        </details>
                    </div>
                `;
                console.error(error);
            }
        };

        // Auto-detect browser capabilities
        window.addEventListener('load', () => {
            const output = document.getElementById('output');

            // Check WebAssembly support
            if (typeof WebAssembly === 'undefined') {
                output.innerHTML = '<div class="status error">‚ùå Your browser does not support WebAssembly</div>';
                return;
            }

            // Check BigInt support
            if (typeof BigInt === 'undefined') {
                output.innerHTML = '<div class="status error">‚ùå Your browser does not support BigInt</div>';
                return;
            }

            // Check ES6 modules
            if (!('noModule' in HTMLScriptElement.prototype)) {
                output.innerHTML = '<div class="status error">‚ùå Your browser does not support ES6 modules</div>';
                return;
            }

            // All checks passed
            output.innerHTML = `
                <div class="status success">
                    ‚úÖ Browser is compatible!<br>
                    - WebAssembly: Supported<br>
                    - BigInt: Supported<br>
                    - ES6 Modules: Supported<br>
                    - User Agent: ${navigator.userAgent}
                </div>
            `;
        });
    </script>
</body>

</html>