<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM Verifier - Real Files Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
        }

        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .file-input {
            margin: 15px 0;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        input[type='file'] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .paths {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }

        .paths code {
            display: block;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>üîê WASM Verifier - Real Files Test</h1>

    <div class="section">
        <h2>üìÇ File Locations</h2>
        <div class="paths">
            <p><strong>Required files in your project:</strong></p>
            <code>1. setupParams.json: packages/frontend/qap-compiler/dist/</code>
            <code>2. instance.json: packages/frontend/synthesizer/examples/outputs/</code>
            <code>3. (Optional) proof.json: packages/backend/prove/output/</code>
        </div>
    </div>

    <div class="section">
        <h2>üì§ Upload Files</h2>

        <div class="file-input">
            <label for="setupParams">1. Setup Parameters (setupParams.json):</label>
            <input type="file" id="setupParams" accept=".json" />
        </div>

        <div class="file-input">
            <label for="instance">2. Instance Data (instance.json):</label>
            <input type="file" id="instance" accept=".json" />
        </div>

        <button onclick="loadAndVerify()">Verify Keccak256</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="section">
        <h2>üìä Results</h2>
        <div id="results"></div>
    </div>

    <div class="section">
        <h2>üìù Detailed Log</h2>
        <div id="log" class="log">Ready to verify...</div>
    </div>

    <script type="module">
        import init, { Verifier } from './pkg-web/verify_wasm.js';

        let wasmInitialized = false;
        let setupParamsData = null;
        let instanceData = null;

        // Initialize WASM on page load
        async function initWasm() {
            if (wasmInitialized) return;

            try {
                addLog('Initializing WASM module...');
                await init();
                wasmInitialized = true;
                addLog('‚úÖ WASM initialized successfully');
            } catch (err) {
                addLog(`‚ùå Failed to initialize WASM: ${err.message}`, 'error');
                throw err;
            }
        }

        // Initialize on page load
        initWasm();

        // Helper: Add log entry
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix =
                type === 'error'
                    ? '‚ùå'
                    : type === 'success'
                        ? '‚úÖ'
                        : type === 'warning'
                            ? '‚ö†Ô∏è'
                            : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Helper: Read file as JSON
        async function readFileAsJson(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        resolve(json);
                    } catch (err) {
                        reject(new Error(`Invalid JSON in ${file.name}: ${err.message}`));
                    }
                };
                reader.onerror = () =>
                    reject(new Error(`Failed to read ${file.name}`));
                reader.readAsText(file);
            });
        }

        // Load files from input
        document.getElementById('setupParams').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                addLog(`Loading ${file.name}...`);
                setupParamsData = await readFileAsJson(file);
                addLog(`‚úÖ Loaded setupParams.json (${file.size} bytes)`, 'success');
                addLog(
                    `   - Constraints (n): ${setupParamsData.n}`,
                );
                addLog(
                    `   - Max placements (s_max): ${setupParamsData.s_max}`,
                );
                addLog(
                    `   - Public I/O: ${setupParamsData.l_pub_in + setupParamsData.l_pub_out}`,
                );
            } catch (err) {
                addLog(`‚ùå Error loading setupParams: ${err.message}`, 'error');
            }
        });

        document.getElementById('instance').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                addLog(`Loading ${file.name}...`);
                instanceData = await readFileAsJson(file);
                addLog(`‚úÖ Loaded instance.json (${file.size} bytes)`, 'success');
                addLog(`   - Public inputs: ${instanceData.a_pub?.length || 0}`);
                addLog(`   - Private inputs: ${instanceData.a_prv?.length || 0}`);
                addLog(
                    `   - Keccak inputs: ${instanceData.publicOutputBuffer?.outPts?.length || 0}`,
                );
                addLog(
                    `   - Keccak outputs: ${instanceData.publicInputBuffer?.inPts?.length || 0}`,
                );
            } catch (err) {
                addLog(`‚ùå Error loading instance: ${err.message}`, 'error');
            }
        });

        // Main verification function
        window.loadAndVerify = async function () {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            try {
                // Validate files loaded
                if (!setupParamsData) {
                    throw new Error('Please upload setupParams.json');
                }
                if (!instanceData) {
                    throw new Error('Please upload instance.json');
                }

                addLog('='.repeat(60));
                addLog('Starting verification process...');
                const startTime = performance.now();

                // Ensure WASM is initialized
                await initWasm();

                // Create verifier
                addLog('Creating verifier instance...');
                const verifier = new Verifier(
                    JSON.stringify(setupParamsData),
                    JSON.stringify(instanceData),
                );
                addLog('‚úÖ Verifier created successfully', 'success');

                // Run Keccak256 verification
                addLog('Running Keccak256 verification...');
                const verifyStart = performance.now();
                const result = verifier.verify_keccak256();
                const verifyTime = ((performance.now() - verifyStart) / 1000).toFixed(3);

                // Interpret result
                let resultText = '';
                let resultClass = '';
                let resultEmoji = '';

                if (result === 0) {
                    // True
                    resultText = 'Keccak256 verification PASSED';
                    resultClass = 'success';
                    resultEmoji = '‚úÖ';
                    addLog('‚úÖ Keccak256 verification PASSED', 'success');
                } else if (result === 1) {
                    // False
                    resultText = 'Keccak256 verification FAILED';
                    resultClass = 'error';
                    resultEmoji = '‚ùå';
                    addLog('‚ùå Keccak256 verification FAILED', 'error');
                } else {
                    // NoKeccakData
                    resultText = 'No Keccak256 data to verify';
                    resultClass = 'warning';
                    resultEmoji = '‚ö†Ô∏è';
                    addLog('‚ö†Ô∏è No Keccak256 data found (this is OK for some transactions)', 'warning');
                }

                const totalTime = ((performance.now() - startTime) / 1000).toFixed(3);

                // Display results
                resultsDiv.innerHTML = `
            <div class="status ${resultClass}">
              <strong>${resultEmoji} ${resultText}</strong>
            </div>
            <div class="status info">
              <strong>‚è±Ô∏è Performance:</strong><br>
              - Verification time: ${verifyTime}s<br>
              - Total time: ${totalTime}s<br>
              - Memory: ~50-100MB
            </div>
            <div class="status info">
              <strong>üìä Data:</strong><br>
              - Setup params: n=${setupParamsData.n}, s_max=${setupParamsData.s_max}<br>
              - Public I/O: ${setupParamsData.l_pub_in + setupParamsData.l_pub_out}<br>
              - Keccak inputs: ${instanceData.publicOutputBuffer?.outPts?.length || 0}<br>
              - Keccak outputs: ${instanceData.publicInputBuffer?.inPts?.length || 0}
            </div>
          `;

                addLog(`‚è±Ô∏è Total time: ${totalTime}s`);
                addLog('üßπ Cleaning up memory...');

                // Clean up
                verifier.free();
                addLog('‚úÖ Memory cleaned up', 'success');
                addLog('='.repeat(60));
            } catch (err) {
                resultsDiv.innerHTML = `
            <div class="status error">
              <strong>‚ùå Error:</strong><br>
              ${err.message}
            </div>
          `;
                addLog(`‚ùå Error: ${err.message}`, 'error');
                console.error('Verification error:', err);
            }
        };

        // Clear results
        window.clearResults = function () {
            document.getElementById('results').innerHTML = '';
            document.getElementById('log').textContent = 'Ready to verify...\n';
            addLog('Results cleared');
        };
    </script>
</body>

</html>