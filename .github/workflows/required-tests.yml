name: Required Integration Tests

on:
  pull_request:
    branches: [main, dev, ale-150]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, dev, ale-150]

jobs:
  # Job 1: í™˜ê²½ ì„¤ì • ë° ê¸°ë³¸ ë¹Œë“œ í…ŒìŠ¤íŠ¸
  setup-and-build:
    name: Setup and Build Test
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix

      - name: Make tokamak-cli executable
        run: chmod +x ./tokamak-cli

      - name: Run installation test
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
        run: |
          # ì„¤ì¹˜ ê³¼ì •ì´ ì„±ê³µí•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
          ./tokamak-cli --install "$ALCHEMY_API_KEY"

      - name: Verify installation
        run: |
          # í•„ìˆ˜ íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          test -f packages/frontend/synthesizer/.env
          test -d packages/backend/dist-linux22
          echo "âœ… Installation verification passed"

  # Job 2: ì‹¤ì œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¦ëª… ìƒì„± í…ŒìŠ¤íŠ¸
  proof-generation-test:
    name: Proof Generation Test
    runs-on: ubuntu-22.04
    needs: setup-and-build
    timeout-minutes: 45

    strategy:
      matrix:
        # ë‹¤ì–‘í•œ íŠ¸ëœì­ì…˜ íƒ€ì…ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
        test_case:
          - name: 'simple-transfer'
            tx_hash: '0x3967fc48fafbee4de2d34655925dae0bb3070807251d5b4569997a58a46586bc'
            description: 'Simple ETH transfer'
          - name: 'contract-call'
            tx_hash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
            description: 'Contract interaction'

      fail-fast: false # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix

      - name: Make tokamak-cli executable
        run: chmod +x ./tokamak-cli

      - name: Setup environment
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
        run: |
          ./tokamak-cli --install "$ALCHEMY_API_KEY"

      - name: Generate proof for ${{ matrix.test_case.name }}
        run: |
          echo "ğŸ§ª Testing: ${{ matrix.test_case.description }}"
          echo "ğŸ“‹ TX Hash: ${{ matrix.test_case.tx_hash }}"

          # ì¦ëª… ìƒì„± ì‹œë„
          ./tokamak-cli --prove "${{ matrix.test_case.tx_hash }}" "./proof_${{ matrix.test_case.name }}"

      - name: Validate proof artifacts
        run: |
          # í•„ìˆ˜ íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          test -f "./proof_${{ matrix.test_case.name }}/transaction_hash.txt"
          test -f "./proof_${{ matrix.test_case.name }}/proof.json"

          # íŠ¸ëœì­ì…˜ í•´ì‹œê°€ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
          stored_hash=$(cat "./proof_${{ matrix.test_case.name }}/transaction_hash.txt")
          if [[ "$stored_hash" != "${{ matrix.test_case.tx_hash }}" ]]; then
            echo "âŒ Transaction hash mismatch!"
            echo "Expected: ${{ matrix.test_case.tx_hash }}"
            echo "Got: $stored_hash"
            exit 1
          fi

          echo "âœ… Proof validation passed for ${{ matrix.test_case.name }}"

      - name: Upload proof artifacts
        if: always() # ì‹¤íŒ¨í•´ë„ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: proof-artifacts-${{ matrix.test_case.name }}-${{ github.run_number }}
          path: ./proof_${{ matrix.test_case.name }}/
          retention-days: 7

  # Job 3: ì„±ëŠ¥ ë° ì•ˆì •ì„± í…ŒìŠ¤íŠ¸
  performance-test:
    name: Performance and Stability Test
    runs-on: ubuntu-22.04
    needs: setup-and-build
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix time

      - name: Make tokamak-cli executable
        run: chmod +x ./tokamak-cli

      - name: Setup environment
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY }}
        run: |
          ./tokamak-cli --install "$ALCHEMY_API_KEY"

      - name: Performance benchmark
        run: |
          echo "ğŸš€ Running performance benchmark..."

          # ì‹œê°„ ì¸¡ì •í•˜ë©´ì„œ ì¦ëª… ìƒì„±
          TX_HASH="0x3967fc48fafbee4de2d34655925dae0bb3070807251d5b4569997a58a46586bc"

          start_time=$(date +%s)
          ./tokamak-cli --prove "$TX_HASH" "./perf_test"
          end_time=$(date +%s)

          duration=$((end_time - start_time))
          echo "â±ï¸ Proof generation took: ${duration} seconds"

          # ì„±ëŠ¥ ì„ê³„ê°’ ì²´í¬ (ì˜ˆ: 10ë¶„ ì´ë‚´)
          if [[ $duration -gt 600 ]]; then
            echo "âŒ Performance test failed: took ${duration}s (limit: 600s)"
            exit 1
          fi

          echo "âœ… Performance test passed: ${duration}s"

      - name: Memory usage test
        run: |
          echo "ğŸ§  Testing memory usage..."

          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§í•˜ë©´ì„œ ì‹¤í–‰
          TX_HASH="0x3967fc48fafbee4de2d34655925dae0bb3070807251d5b4569997a58a46586bc"

          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§
          (while true; do
            ps aux | grep -E "(tokamak-cli|node|npm)" | grep -v grep >> memory_usage.log
            sleep 5
          done) &
          monitor_pid=$!

          ./tokamak-cli --prove "$TX_HASH" "./memory_test"

          # ëª¨ë‹ˆí„°ë§ ì¤‘ë‹¨
          kill $monitor_pid 2>/dev/null || true

          echo "âœ… Memory usage test completed"

  # Job 4: ìµœì¢… ìƒíƒœ ì²´í¬
  final-status:
    name: Final Status Check
    runs-on: ubuntu-22.04
    needs: [setup-and-build, proof-generation-test, performance-test]
    if: always()

    steps:
      - name: Check all tests passed
        run: |
          echo "ğŸ” Checking test results..."

          # needs contextì—ì„œ ëª¨ë“  jobì˜ ê²°ê³¼ í™•ì¸
          setup_result="${{ needs.setup-and-build.result }}"
          proof_result="${{ needs.proof-generation-test.result }}"
          perf_result="${{ needs.performance-test.result }}"

          echo "Setup and Build: $setup_result"
          echo "Proof Generation: $proof_result"
          echo "Performance Test: $perf_result"

          if [[ "$setup_result" != "success" || "$proof_result" != "success" || "$perf_result" != "success" ]]; then
            echo "âŒ One or more tests failed!"
            echo "ğŸš« This PR cannot be merged until all tests pass."
            exit 1
          fi

          echo "âœ… All tests passed! Ready for merge."
