name: Required Integration Tests

on:
  pull_request:
    branches: [main, dev, ale-150]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, dev, ale-150]

jobs:
  # Job 1: ì‹¤ì œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¦ëª… ìƒì„± í…ŒìŠ¤íŠ¸
  proof-generation-test:
    name: Proof Generation Test
    runs-on: macos-latest
    timeout-minutes: 45

    strategy:
      matrix:
        # TON Transfer í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
        test_case:
          - name: 'ton-transfer'
            tx_hash: '0x6c7903e420c5efb27639f5186a7474ef2137f12c786a90b4efdcb5d88dfdb002'
            description: 'TON Transfer'

      fail-fast: false # í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install system dependencies
        run: |
          # macOSì—ì„œëŠ” homebrew ì‚¬ìš©
          brew install dos2unix cmake

      - name: Install Rust and Cargo
        uses: dtolnay/rust-toolchain@stable

      - name: Install circom
        run: |
          # Install circom 2.2.2 for macOS
          wget https://github.com/iden3/circom/releases/download/v2.2.2/circom-macos-amd64
          chmod +x circom-macos-amd64
          sudo mv circom-macos-amd64 /usr/local/bin/circom
          circom --version

      - name: Make tokamak-cli executable
        run: chmod +x ./tokamak-cli

      - name: Setup environment
        env:
          ALCHEMY_API_KEY: ${{ secrets.ALCHEMY_API_KEY || 'test_api_key_placeholder' }}
        run: |
          # íŒŒì¼ ê¶Œí•œ ë° ë¼ì¸ ì—”ë”© ìˆ˜ì •
          echo "ğŸ”§ Fixing file permissions and line endings..."
          find . -name "*.sh" -exec chmod +x {} \;
          find . -name "*.sh" -exec dos2unix {} \; 2>/dev/null || true

          # npm ì˜ì¡´ì„± ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ npm install ì‚¬ìš©
          echo "ğŸ”§ Installing dependencies with npm install instead of npm ci..."
          cd packages/frontend/qap-compiler && npm install --legacy-peer-deps
          cd ../synthesizer && npm install --legacy-peer-deps
          cd ../../..

          # tsx ê¸€ë¡œë²Œ ì„¤ì¹˜ (synthesizerì—ì„œ í•„ìš”)
          npm install -g tsx
          ./tokamak-cli --install "$ALCHEMY_API_KEY"

      - name: Generate proof for ${{ matrix.test_case.name }}
        run: |
          echo "ğŸ§ª Testing: ${{ matrix.test_case.description }}"
          echo "ğŸ“‹ TX Hash: ${{ matrix.test_case.tx_hash }}"

          # ì¦ëª… ìƒì„± ì‹œë„
          ./tokamak-cli --prove "${{ matrix.test_case.tx_hash }}" "./proof_${{ matrix.test_case.name }}"

      - name: Validate proof artifacts
        run: |
          # í•„ìˆ˜ íŒŒì¼ë“¤ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          test -f "./proof_${{ matrix.test_case.name }}/transaction_hash.txt"
          test -f "./proof_${{ matrix.test_case.name }}/proof.json"

          # íŠ¸ëœì­ì…˜ í•´ì‹œê°€ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
          stored_hash=$(cat "./proof_${{ matrix.test_case.name }}/transaction_hash.txt")
          if [[ "$stored_hash" != "${{ matrix.test_case.tx_hash }}" ]]; then
            echo "âŒ Transaction hash mismatch!"
            echo "Expected: ${{ matrix.test_case.tx_hash }}"
            echo "Got: $stored_hash"
            exit 1
          fi

          echo "âœ… Proof validation passed for ${{ matrix.test_case.name }}"

      - name: Upload proof artifacts
        if: always() # ì‹¤íŒ¨í•´ë„ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: proof-artifacts-${{ matrix.test_case.name }}-${{ github.run_number }}
          path: ./proof_${{ matrix.test_case.name }}/
          retention-days: 7

  # Job 2: ìµœì¢… ìƒíƒœ ì²´í¬
  final-status:
    name: Final Status Check
    runs-on: macos-latest
    needs: proof-generation-test
    if: always()

    steps:
      - name: Check all tests passed
        run: |
          echo "ğŸ” Checking test results..."

          # needs contextì—ì„œ ëª¨ë“  jobì˜ ê²°ê³¼ í™•ì¸
          proof_result="${{ needs.proof-generation-test.result }}"

          echo "Proof Generation: $proof_result"

          if [[ "$proof_result" != "success" ]]; then
            echo "âŒ Proof generation test failed!"
            echo "ğŸš« This PR cannot be merged until all tests pass."
            exit 1
          fi

          echo "âœ… All tests passed! Ready for merge."
